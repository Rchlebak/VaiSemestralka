<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Detail produktu - E-shop Tenisiek</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .variant-btn { min-width: 50px; }
        .variant-btn.active { border-color: var(--primary); background: #e0f2fe; }
        .variant-btn.out-of-stock { opacity: 0.5; text-decoration: line-through; }
        .product-main-image { width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px; background: #f8f9fa; }
        .stock-info { font-size: 0.9rem; }
        .stock-info.in-stock { color: #10b981; }
        .stock-info.low-stock { color: #f59e0b; }
        .stock-info.out-of-stock { color: #ef4444; }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-light bg-light mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">← E-Shop Tenisiek</a>
        <a href="#" class="btn btn-outline-primary" id="open-cart">Košík (<span id="cart-count">0</span>)</a>
    </div>
</nav>

<div class="container py-2">
    <div id="product-root">
        <div class="row">
            <div class="col-md-6">
                <img id="product-image" class="product-main-image" src="https://via.placeholder.com/400" alt="Product">
                <div id="image-gallery" class="mt-3 d-flex gap-2 flex-wrap"></div>
            </div>
            <div class="col-md-6">
                <div class="mb-2">
                    <span class="badge bg-secondary" id="p-brand">Značka</span>
                    <span class="badge bg-light text-dark" id="p-sku">SKU</span>
                </div>
                <h2 id="p-name">Načítavam...</h2>
                <div class="d-flex align-items-baseline gap-2 mb-3">
                    <span class="price fs-3" id="p-price">0 €</span>
                    <span class="old-price" id="p-old-price"></span>
                </div>
                <p id="p-desc" class="text-muted">Popis produktu...</p>

                <hr>

                <div class="mb-3">
                    <label class="form-label fw-bold">Farba</label>
                    <div id="variant-colors" class="variant-select d-flex gap-2 flex-wrap"></div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Veľkosť</label>
                    <div id="variant-sizes" class="variant-select d-flex gap-2 flex-wrap"></div>
                </div>

                <div id="stock-status" class="stock-info mb-3"></div>

                <div class="d-flex gap-2 align-items-center mb-3">
                    <label class="form-label mb-0">Množstvo:</label>
                    <div class="input-group" style="width:120px">
                        <button class="btn btn-outline-secondary" id="qty-minus">−</button>
                        <input type="number" class="form-control text-center" id="qty-input" value="1" min="1">
                        <button class="btn btn-outline-secondary" id="qty-plus">+</button>
                    </div>
                </div>

                <button id="add-to-cart" class="btn btn-primary btn-lg btn-primary-custom w-100" disabled>
                    Pridať do košíka
                </button>

                <div class="mt-4 p-3 bg-light rounded">
                    <small class="text-muted">
                        ✓ Doprava zadarmo nad 50€<br>
                        ✓ Vrátenie do 30 dní<br>
                        ✓ Bezpečná platba
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cart Drawer -->
<aside id="cart-drawer" class="cart-drawer">
    <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Váš košík</h5>
            <button id="close-cart" class="btn btn-sm btn-outline-secondary">Zavrieť</button>
        </div>
        <div id="cart-items"></div>
        <div class="mt-3">
            <div class="d-flex justify-content-between">
                <strong>Medzisúčet:</strong>
                <span id="cart-subtotal">0 €</span>
            </div>
            <a href="checkout.html" class="btn btn-primary btn-block btn-primary-custom w-100 mt-3">Pokladňa</a>
        </div>
    </div>
</aside>

<script src="js/app.js"></script>
<script src="js/cart.js"></script>
<script>
(async function(){
    const url = new URL(location.href);
    const id = url.searchParams.get('id');
    if(!id) {
        document.getElementById('p-name').textContent = 'Produkt nebol nájdený';
        return;
    }

    let productData = null;
    let variants = [];
    let selectedColor = null;
    let selectedSize = null;
    let selectedVariant = null;

    try {
        const res = await apiFetch('/api/product.php?id=' + encodeURIComponent(id));
        if(!res.ok) throw new Error('Product not found');

        productData = res.data.product;
        variants = res.data.variants || [];

        // Set basic info
        document.getElementById('p-name').textContent = productData.name;
        document.getElementById('p-price').textContent = parseFloat(productData.base_price || productData.price || 0).toFixed(2) + ' €';
        document.getElementById('p-desc').textContent = productData.description || 'Bez popisu';
        document.getElementById('p-brand').textContent = productData.brand || 'Neznáma značka';
        document.getElementById('p-sku').textContent = productData.sku_model || '';
        document.title = productData.name + ' - E-shop Tenisiek';

        // Set image
        const images = res.data.images || [];
        const mainImg = document.getElementById('product-image');
        if(images.length > 0) {
            mainImg.src = images[0];
        } else {
            mainImg.src = 'https://picsum.photos/seed/p' + id + '/400/400';
        }

        // Image gallery
        if(images.length > 1) {
            const gallery = document.getElementById('image-gallery');
            images.forEach((img, idx) => {
                const thumb = document.createElement('img');
                thumb.src = img;
                thumb.style.cssText = 'width:60px;height:60px;object-fit:cover;border-radius:4px;cursor:pointer;border:2px solid transparent;';
                thumb.addEventListener('click', () => {
                    mainImg.src = img;
                    gallery.querySelectorAll('img').forEach(t => t.style.borderColor = 'transparent');
                    thumb.style.borderColor = '#0d6efd';
                });
                gallery.appendChild(thumb);
            });
        }

        // Get unique colors and sizes
        const colors = [...new Set(variants.map(v => v.color).filter(Boolean))];
        const sizes = [...new Set(variants.map(v => v.size_eu).filter(Boolean))];

        // Render color buttons
        const colorsEl = document.getElementById('variant-colors');
        colors.forEach(color => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-secondary variant-btn';
            btn.textContent = color;
            btn.dataset.color = color;
            btn.addEventListener('click', () => selectColor(color));
            colorsEl.appendChild(btn);
        });

        // Render size buttons
        const sizesEl = document.getElementById('variant-sizes');
        sizes.forEach(size => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-outline-secondary variant-btn';
            btn.textContent = size;
            btn.dataset.size = size;
            btn.addEventListener('click', () => selectSize(size));
            sizesEl.appendChild(btn);
        });

        // If only one color/size, auto-select
        if(colors.length === 1) selectColor(colors[0]);
        if(sizes.length === 1) selectSize(sizes[0]);

        // If no variants, enable add to cart
        if(variants.length === 0) {
            document.getElementById('add-to-cart').disabled = false;
            document.getElementById('stock-status').innerHTML = '<span class="in-stock">✓ Na sklade</span>';
        }

    } catch(e) {
        console.error(e);
        document.getElementById('p-name').textContent = 'Chyba pri načítaní produktu';
    }

    function selectColor(color) {
        selectedColor = color;
        document.querySelectorAll('#variant-colors .variant-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.color === color);
        });
        updateVariantSelection();
    }

    function selectSize(size) {
        selectedSize = size;
        document.querySelectorAll('#variant-sizes .variant-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.size === size);
        });
        updateVariantSelection();
    }

    function updateVariantSelection() {
        selectedVariant = null;

        if(selectedColor && selectedSize) {
            selectedVariant = variants.find(v => v.color === selectedColor && v.size_eu === selectedSize);
        }

        const stockEl = document.getElementById('stock-status');
        const addBtn = document.getElementById('add-to-cart');

        if(selectedVariant) {
            const stock = parseInt(selectedVariant.stock_qty) || 0;
            if(stock > 10) {
                stockEl.innerHTML = '<span class="in-stock">✓ Na sklade (' + stock + ' ks)</span>';
                addBtn.disabled = false;
            } else if(stock > 0) {
                stockEl.innerHTML = '<span class="low-stock">⚠ Posledných ' + stock + ' kusov!</span>';
                addBtn.disabled = false;
            } else {
                stockEl.innerHTML = '<span class="out-of-stock">✗ Vypredané</span>';
                addBtn.disabled = true;
            }
        } else if(selectedColor || selectedSize) {
            stockEl.innerHTML = '<span class="text-muted">Vyberte farbu a veľkosť</span>';
            addBtn.disabled = true;
        } else {
            stockEl.innerHTML = '';
            addBtn.disabled = true;
        }

        // Update size availability based on color
        if(selectedColor) {
            const availableSizes = variants.filter(v => v.color === selectedColor).map(v => v.size_eu);
            document.querySelectorAll('#variant-sizes .variant-btn').forEach(btn => {
                const hasStock = variants.some(v => v.color === selectedColor && v.size_eu === btn.dataset.size && v.stock_qty > 0);
                btn.classList.toggle('out-of-stock', !hasStock);
            });
        }
    }

    // Quantity controls
    document.getElementById('qty-minus').addEventListener('click', () => {
        const input = document.getElementById('qty-input');
        if(parseInt(input.value) > 1) input.value = parseInt(input.value) - 1;
    });

    document.getElementById('qty-plus').addEventListener('click', () => {
        const input = document.getElementById('qty-input');
        input.value = parseInt(input.value) + 1;
    });

    // Add to cart
    document.getElementById('add-to-cart').addEventListener('click', () => {
        if(!productData) return;

        const qty = parseInt(document.getElementById('qty-input').value) || 1;
        const images = productData.images || [];

        Cart.addItem({
            productId: productData.product_id || id,
            variantId: selectedVariant ? selectedVariant.variant_id : null,
            name: productData.name,
            price: parseFloat(productData.base_price || productData.price || 0),
            qty: qty,
            image: images.length > 0 ? images[0] : 'https://picsum.photos/seed/p' + id + '/80/80',
            variant: selectedVariant ? { color: selectedVariant.color, size: selectedVariant.size_eu } : null
        });

        // Open cart drawer
        document.getElementById('cart-drawer')?.classList.add('open');
    });
})();
</script>
</body>
</html>
