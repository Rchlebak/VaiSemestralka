<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Poklad≈àa - E-shop Tenisiek</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .checkout-item { border-bottom: 1px solid #e5e7eb; padding: 12px 0; }
        .checkout-item:last-child { border-bottom: none; }
        .order-summary { background: #f8f9fa; border-radius: 8px; padding: 20px; }
    </style>
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-light bg-light mb-4">
    <div class="container">
        <a class="navbar-brand" href="/">‚Üê E-Shop Tenisiek</a>
    </div>
</nav>

<div class="container py-2">
    <h2 class="mb-4">Poklad≈àa</h2>

    <div class="row">
        <!-- Order form -->
        <div class="col-md-7">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Kontaktn√© √∫daje</h5>
                </div>
                <div class="card-body">
                    <form id="checkout-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="name" class="form-label">Meno a priezvisko *</label>
                                <input id="name" class="form-control" required placeholder="J√°n Nov√°k">
                                <div class="invalid-feedback">Meno je povinn√© (min. 2 znaky)</div>
                            </div>
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email *</label>
                                <input id="email" class="form-control" type="email" required placeholder="jan@example.com">
                                <div class="invalid-feedback">Zadajte platn√Ω email</div>
                            </div>
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Telef√≥n</label>
                                <input id="phone" class="form-control" type="tel" placeholder="+421 900 123 456">
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Doruƒçovacia adresa</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="street" class="form-label">Ulica a ƒç√≠slo *</label>
                            <input id="street" class="form-control" required placeholder="Hlavn√° 123">
                            <div class="invalid-feedback">Zadajte ulicu a ƒç√≠slo</div>
                        </div>
                        <div class="col-md-6">
                            <label for="city" class="form-label">Mesto *</label>
                            <input id="city" class="form-control" required placeholder="Bratislava">
                            <div class="invalid-feedback">Zadajte mesto</div>
                        </div>
                        <div class="col-md-3">
                            <label for="zip" class="form-label">PSƒå *</label>
                            <input id="zip" class="form-control" required placeholder="81101">
                            <div class="invalid-feedback">Zadajte PSƒå</div>
                        </div>
                        <div class="col-md-3">
                            <label for="country" class="form-label">Krajina</label>
                            <select id="country" class="form-select">
                                <option value="SK" selected>Slovensko</option>
                                <option value="CZ">ƒåesko</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Sp√¥sob platby</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment" id="payment-card" value="card" checked>
                        <label class="form-check-label" for="payment-card">
                            üí≥ Platba kartou online
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="payment" id="payment-cod" value="cod">
                        <label class="form-check-label" for="payment-cod">
                            üì¶ Dobierka (+2‚Ç¨)
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment" id="payment-transfer" value="transfer">
                        <label class="form-check-label" for="payment-transfer">
                            üè¶ Bankov√Ω prevod
                        </label>
                    </div>
                </div>
            </div>

            <div id="checkout-result"></div>

            <button id="submit-order" class="btn btn-primary btn-lg btn-primary-custom w-100">
                Odosla≈• objedn√°vku
            </button>
        </div>

        <!-- Order summary -->
        <div class="col-md-5">
            <div class="order-summary sticky-top" style="top:20px">
                <h5 class="mb-3">S√∫hrn objedn√°vky</h5>
                <div id="checkout-items"></div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                    <span>Medzis√∫ƒçet:</span>
                    <span id="subtotal">0 ‚Ç¨</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Doprava:</span>
                    <span id="shipping">0 ‚Ç¨</span>
                </div>
                <div class="d-flex justify-content-between mb-2" id="cod-fee-row" style="display:none!important">
                    <span>Dobierka:</span>
                    <span>2 ‚Ç¨</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Celkom:</strong>
                    <strong id="total" class="fs-4">0 ‚Ç¨</strong>
                </div>
                <div class="text-muted small mt-2">Doprava zadarmo nad 50‚Ç¨</div>
            </div>
        </div>
    </div>
</div>

<script src="js/app.js"></script>
<script src="js/cart.js"></script>
<script>
(function(){
    const cart = Cart.getCart();
    const FREE_SHIPPING_THRESHOLD = 50;
    const SHIPPING_COST = 4.99;
    const COD_FEE = 2;

    function renderItems(){
        const container = document.getElementById('checkout-items');
        if(cart.items.length === 0){
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-muted">V√°≈° ko≈°√≠k je pr√°zdny</div>
                    <a href="/" class="btn btn-sm btn-outline-primary mt-2">Pokraƒçova≈• v n√°kupe</a>
                </div>
            `;
            document.getElementById('submit-order').disabled = true;
            return;
        }

        container.innerHTML = cart.items.map(item => `
            <div class="checkout-item d-flex gap-3">
                <img src="${item.image || 'https://picsum.photos/seed/p'+item.productId+'/60/60'}"
                     style="width:50px;height:50px;object-fit:cover;border-radius:4px">
                <div class="flex-grow-1">
                    <div style="font-weight:500">${item.name}</div>
                    ${item.variant ? `<small class="text-muted">${item.variant.color || ''} / ${item.variant.size || ''}</small>` : ''}
                    <div class="small">${item.qty} √ó ${item.price.toFixed(2)} ‚Ç¨</div>
                </div>
                <div style="font-weight:600">${(item.price * item.qty).toFixed(2)} ‚Ç¨</div>
            </div>
        `).join('');
    }

    function updateTotals(){
        const subtotal = cart.items.reduce((s, i) => s + (i.price * i.qty), 0);
        const shipping = subtotal >= FREE_SHIPPING_THRESHOLD ? 0 : SHIPPING_COST;
        const isCod = document.querySelector('input[name="payment"]:checked')?.value === 'cod';
        const codFee = isCod ? COD_FEE : 0;
        const total = subtotal + shipping + codFee;

        document.getElementById('subtotal').textContent = subtotal.toFixed(2) + ' ‚Ç¨';
        document.getElementById('shipping').textContent = shipping === 0 ? 'Zadarmo' : shipping.toFixed(2) + ' ‚Ç¨';
        document.getElementById('total').textContent = total.toFixed(2) + ' ‚Ç¨';

        const codRow = document.getElementById('cod-fee-row');
        if(codRow) codRow.style.display = isCod ? 'flex' : 'none';
    }

    renderItems();
    updateTotals();

    // Update on payment change
    document.querySelectorAll('input[name="payment"]').forEach(r => {
        r.addEventListener('change', updateTotals);
    });

    // Form validation and submission
    document.getElementById('submit-order').addEventListener('click', async function(){
        const name = document.getElementById('name').value.trim();
        const email = document.getElementById('email').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const street = document.getElementById('street').value.trim();
        const city = document.getElementById('city').value.trim();
        const zip = document.getElementById('zip').value.trim();
        const country = document.getElementById('country').value;
        const payment = document.querySelector('input[name="payment"]:checked')?.value || 'card';

        // Validation
        const errors = [];
        let isValid = true;

        // Reset validation states
        document.querySelectorAll('.form-control').forEach(el => el.classList.remove('is-invalid'));

        if(name.length < 2) {
            document.getElementById('name').classList.add('is-invalid');
            errors.push('Meno je povinn√©');
            isValid = false;
        }
        if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
            document.getElementById('email').classList.add('is-invalid');
            errors.push('Neplatn√Ω email');
            isValid = false;
        }
        if(street.length < 3) {
            document.getElementById('street').classList.add('is-invalid');
            errors.push('Zadajte ulicu');
            isValid = false;
        }
        if(city.length < 2) {
            document.getElementById('city').classList.add('is-invalid');
            errors.push('Zadajte mesto');
            isValid = false;
        }
        if(!/^\d{5}$/.test(zip.replace(/\s/g, ''))) {
            document.getElementById('zip').classList.add('is-invalid');
            errors.push('Neplatn√© PSƒå');
            isValid = false;
        }
        if(cart.items.length === 0) {
            errors.push('Ko≈°√≠k je pr√°zdny');
            isValid = false;
        }

        if(!isValid) {
            document.getElementById('checkout-result').innerHTML = `
                <div class="alert alert-danger">${errors.join('<br>')}</div>
            `;
            return;
        }

        // Disable button
        this.disabled = true;
        this.textContent = 'Spracov√°vam...';

        const payload = {
            customer_name: name,
            customer_email: email,
            customer_phone: phone,
            ship_street: street,
            ship_city: city,
            ship_zip: zip,
            ship_country: country,
            payment_method: payment,
            cart: cart.items
        };

        try {
            const res = await apiFetch('/api/orders.php', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                // Clear cart
                Cart.clear();

                document.getElementById('checkout-result').innerHTML = `
                    <div class="alert alert-success">
                        <h5>‚úì Objedn√°vka prijat√°!</h5>
                        <p>ƒå√≠slo objedn√°vky: <strong>${res.order_number || res.order_id}</strong></p>
                        <p>Potvrdenie sme poslali na ${email}</p>
                        <a href="/" class="btn btn-primary mt-2">Sp√§≈• na obchod</a>
                    </div>
                `;

                // Hide form
                document.querySelectorAll('.card').forEach(c => c.style.display = 'none');
                this.style.display = 'none';
                renderItems();
            } else {
                const err = res.errors ? Object.values(res.errors).join('<br>') : (res.error || 'Chyba pri spracovan√≠ objedn√°vky');
                document.getElementById('checkout-result').innerHTML = `
                    <div class="alert alert-danger">${err}</div>
                `;
                this.disabled = false;
                this.textContent = 'Odosla≈• objedn√°vku';
            }
        } catch(e) {
            console.error(e);
            document.getElementById('checkout-result').innerHTML = `
                <div class="alert alert-danger">Chyba pripojenia. Sk√∫ste znova.</div>
            `;
            this.disabled = false;
            this.textContent = 'Odosla≈• objedn√°vku';
        }
    });
})();
</script>
</body>
</html>
